<!DOCTYPE html>
<html>
  <head>
      <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>

      <script src="video.js"></script>
    
      <style>
        body {
          margin: 0;
          padding: 0;
        }
        #wrapper {
            position: relative;
            padding: 0 0 56.25% 0;
            height: 0;
        }
        #wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            z-index:1;
        }

        #wrapper #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color:black;
            z-index:2000;
        }

        #wrapper #controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index:1999;
        }
        #wrapper #controls-overlay a img {
          width:15%;
          max-width:200px;
        }

        #wrapper #controls-overlay a {
          display:block;
        }



        #wrapper #unmute-overlay {
          position: absolute;
          top: 0;
          left: 0;
          z-index:1998;
        }
        #wrapper #unmute-overlay a {
          padding: 10px;
          display: block;
        }
      </style>
  </head>
  <body>
    <script>
              var player; //will hold YT player ref
    </script>
    <div id="wrapper">
        <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
      <div id="player"></div>
      <div id="controls-overlay">
        <a href="#" id="resync-button">
          <img src="img/sync-cta.png" style="width:300px; border:0px" />
        </a>
      </div>
      <div id="unmute-overlay">
          <a href="#" id="unmute-initial" onclick="javascript:player.unMute(); return false;">
            <img src="img/unmute-cta.png" style="width:300px; border:0px" />
          </a>
      </div>

      <div id="loading-overlay"></div>
    </div>
    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          playerVars: {
              enablejsapi: 1,
              playsinline: 1, 
              autoplay: 1,
              controls: 0,
              allowfullscreen: 0,
              fs: 1,
              showinfo:1,
              modestbranding: 1
          },
          //videoId: 'M7lc1UVf-VE',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      //    We get the latest playlist and global offset data from the server, then start playing at the correct track + time
      function onPlayerReady(event) {
        event.target.mute();
        getChannelData('TrueLifeTV', (json) => {
          //cue the playlist. This gets the video IDs without costing me an API call to gdata
          event.target.cuePlaylist({list:json.playlistId,
                      listType:'playlist',
                      //index:0,
                      //startSeconds:parseInt(json.elapsedTime/1000),
                      //suggestedQuality:'medium'
                    })
        })
      }

      // The player fires events here when asynchronous operations complete, or there is a 
      // change in playback state (caused by user or otherwise). 
      var initialLoadComplete = false;

      function onPlayerStateChange(event) {
        //This is called when cuePlaylist is done, and we can get the video ids.
        //We then get the details of the videos, so we can calculate the start time
        if (event.data == 5 && !initialLoadComplete) {
          initialLoadComplete = true;

          var videoIds = player.getPlaylist();
          getPlaylistDetails(videoIds, (details)=> {
            //make the calculation of playlist index and start time based on playlist duration and elapsed time
            [index, offset] = calculateSync(details, parseInt(channelData.elapsedTime / 1000))

            //load the playlist and start playing appropriately. 
            player.setLoop(true)
            player.setShuffle(false)
            player.playVideoAt(index)
            player.seekTo(offset, true)
            /*
            player.loadPlaylist({
                      list:videoIds,
                      listType:'playlist',
                      index:index,
                      startSeconds:offset,
                      //suggestedQuality:'medium'
                    }) */
          })
        }
        if (event.data == YT.PlayerState.PLAYING && initialLoadComplete) {
          //player.unMute();
          //initialLoadComplete = true;
          $("#loading-overlay").hide()
          $("#controls-overlay").show()
        }
      }
      function stopVideo() {
        player.stopVideo();
      }


      $(() => {
        $("#unmute-initial").on("click", () => {
          player.unMute(); 
          $("#unmute-overlay").hide()
          return false
        })
        $("#resync-button").on("click", (e) => {
          resync()
          e.preventDefault()
        })
      })
    </script>

</html>
