<!DOCTYPE html>
<html>
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>

      <script src="video.js"></script>
  
      <link rel="stylesheet" href="video.css" />
  </head>
  <body>
    <script>
        //select channel with querystring ...admin.html?channel=
        window['selectedChannel'] = getUrlVars()["channel"] || "TrueLifeTV"
    </script>

    <script>
              var player; //will hold YT player ref
    </script>
    <div id="wrapper">
        <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
      <div id="player"></div>
      <!-- A transparent overlay that accomplishes what showinfo: 0 used to do, and 
           prevents the YouTube info UI from being shown or interacted with -->
      <div id="clearcoat"></div> 
      <!-- Control bar -->
      <div id="controls-overlay">
        <a href="#" id="resync-button">
          <img src="img/sync-cta.png" style="border:0px" />
        </a>
      </div>
      <!-- Initial unmute for mobile-->
      <div id="unmute-overlay">
          <a href="javascript:player.unMute();$('#unmute-overlay').hide()" id="unmute-initial">
              <img src="img/unmute-cta.png" style="border:0px" />
          </a>
      </div>

      <!-- Container for UI to show while waiting for player to load.
           This would be a good place to stick a box ad -->
      <div id="loading-overlay"></div>
    </div>
    <script>
          
      var startLoad = 0,      //Timestamped when the YouTube player is loaded and the server has given us the playlist id and elapsedTime value
          endLoad=0,          //Timestamped when the YouTube player has cued the playlist... endLoad - startLoad is the MINIMUM additional offset beyond that calculated by the server
          playbackStarted=0   //Timestamped when the player starts playing. Used for profiling only - by looking at the difference between this and endLoad in a variety of environments, we can come up with an average additional offset for the sync. 


      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          playerVars: {
              enablejsapi: 1,
              playsinline: 1, 
              autoplay: 1,
              controls: 0,
              allowfullscreen: 0,
              fs: 1,
              showinfo:1,
              modestbranding: 1
          },
          //videoId: 'M7lc1UVf-VE',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      //    We get the latest playlist and global offset data from the server, then start playing at the correct track + time
      function onPlayerReady(event) {
        event.target.mute();
        getChannelData(window['selectedChannel'], (json) => {
          startLoad = Date.now()
          //cue the playlist. This gets the video IDs without costing me an API call to gdata
          event.target.cuePlaylist({list:json.playlistId,
                      listType:'playlist',
                      //index:0,
                      //startSeconds:parseInt(json.elapsedTime/1000),
                      //suggestedQuality:'medium'
                    })
        })
      }

      // The player fires events here when asynchronous operations complete, or there is a 
      // change in playback state (caused by user or otherwise). 
      var initialLoadComplete = false;

      function onPlayerStateChange(event) {
        //This is called when cuePlaylist is done, and we can get the video ids.
        //We then get the details of the videos, so we can calculate the start time
        if (event.data == 5 && !initialLoadComplete) {
          initialLoadComplete = true;

          var videoIds = player.getPlaylist();
          getPlaylistDetails(videoIds, (details)=> {
            endLoad = Date.now()
            //add the player load time to the elapsed time retrieved from the server 
            var elapsed = channelData.elapsedTime + (endLoad - startLoad); 

            //make the calculation of playlist index and start time based on playlist duration and elapsed time
            [index, offset] = calculateSync(details, Math.round(elapsed/1000))

            //load the playlist and start playing appropriately. 
            player.setLoop(true)
            player.setShuffle(false)
            player.playVideoAt(index)
            player.seekTo(offset, true)
            /*
            player.loadPlaylist({
                      list:videoIds,
                      listType:'playlist',
                      index:index,
                      startSeconds:offset,
                      //suggestedQuality:'medium'
                    }) */
          })
        }
        if (event.data == YT.PlayerState.PLAYING && initialLoadComplete) {
          //player.unMute();
          //initialLoadComplete = true;
          playbackStarted = Date.now()

          //profiling info - todo: store in DB
          console.log(`startLoad: ${startLoad}
                       endLoad: ${endLoad}
                       start/end difference: ${endLoad - startLoad}

                       playbackStarted: ${playbackStarted}
                       buffering time (playBackStarted - endload): ${playBackStarted - endLoad}`)

          $("#loading-overlay").hide()
          $("#controls-overlay").show()
        }
      }
      function stopVideo() {
        player.stopVideo();
      }


      $(() => {
        /*
        $("#unmute-initial").on("click", (e) => {
          player.unMute(); 
          $("#unmute-overlay").hide()
          e.preventDefault()

          //return false
        }) */
        $("#resync-button").on("click", (e) => {
          resync()
          e.preventDefault()
        })
        //$("#clearcoat").on("click", (e) => {e.preventDefault()})
      })
    </script>
  </body>
</html>
